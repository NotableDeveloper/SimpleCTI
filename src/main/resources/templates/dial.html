<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Simple CTI - Web Softphone</title>
    <script th:src="@{/js/jssip.min.js}"></script>
    <script>
        window.onload = function() {
            if (typeof JsSIP !== 'undefined') {
                console.log('JsSIP library loaded successfully');
            } else {
                console.error('Failed to load JsSIP library');
                alert('JsSIP library could not be loaded. Please check your internet connection or CDN link.');
            }
        };
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            text-align: center;
            background-color: #ffffff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 100%;
        }
        h1 {
            color: #1c1e21;
            font-size: 28px;
            margin-bottom: 24px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            text-align: left;
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #606770;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .button {
            display: inline-block;
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border-radius: 6px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button.secondary {
            background-color: #6c757d;
        }
        .button.secondary:hover {
            background-color: #545b62;
        }
        .button.danger {
            background-color: #dc3545;
        }
        .button.danger:hover {
            background-color: #c82333;
        }
        .status-bar {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }
        .status-disconnected { background-color: #ffeeba; color: #856404; }
        .status-registered { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .keypad button {
            padding: 15px;
            font-size: 20px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            background-color: #ffffff;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .keypad button:hover {
            background-color: #f0f2f5;
        }
        .call-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        #remoteAudio {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Web Softphone</h1>

        <!-- Settings Section -->
        <div class="section">
            <span class="section-title">SIP Settings</span>
            <div class="form-group">
                <label for="sipUri">SIP URI (e.g., sip:1001@192.168.1.10)</label>
                <input type="text" id="sipUri" placeholder="sip:ext@domain">
            </div>
            <div class="form-group">
                <label for="sipPassword">Password</label>
                <input type="password" id="sipPassword" placeholder="Secret">
            </div>
            <div class="form-group">
                <label for="wsUrl">WebSocket URL (e.g., wss://192.168.1.10:8089/ws)</label>
                <input type="text" id="wsUrl" placeholder="wss://server:port/ws">
            </div>
            <button id="connectBtn" class="button secondary" onclick="connectToSip()">Connect & Register</button>
            <button id="micTestBtn" class="button" style="margin-top: 10px; background-color: #17a2b8;" onclick="testMicrophone()">ðŸŽ¤ Test Microphone Permissions</button>
            <div id="status" class="status-bar status-disconnected">Disconnected</div>
        </div>

        <!-- Dialer Section -->
        <div class="section">
            <div class="form-group">
                <label for="targetNumber">Phone Number</label>
                <input type="text" id="targetNumber" placeholder="Enter number to call">
            </div>
            
            <div class="call-controls">
                <button id="callBtn" class="button" onclick="makeCall()">Call</button>
                <button id="hangupBtn" class="button danger" onclick="hangupCall()" disabled>Hangup</button>
            </div>

            <div class="keypad">
                <button onclick="appendNumber('1')">1</button>
                <button onclick="appendNumber('2')">2</button>
                <button onclick="appendNumber('3')">3</button>
                <button onclick="appendNumber('4')">4</button>
                <button onclick="appendNumber('5')">5</button>
                <button onclick="appendNumber('6')">6</button>
                <button onclick="appendNumber('7')">7</button>
                <button onclick="appendNumber('8')">8</button>
                <button onclick="appendNumber('9')">9</button>
                <button onclick="clearInput()">Clear</button>
                <button onclick="appendNumber('0')">0</button>
                <button onclick="backspace()">&lt;-</button>
            </div>
        </div>

        <audio id="remoteAudio" autoplay></audio>
    </div>

    <script>
        let ua = null;
        let session = null;

        // --- UI Helper Functions ---
        function appendNumber(number) {
            document.getElementById('targetNumber').value += number;
        }

        function clearInput() {
            document.getElementById('targetNumber').value = '';
        }

        function backspace() {
            const targetNumber = document.getElementById('targetNumber');
            targetNumber.value = targetNumber.value.slice(0, -1);
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status-bar ' + type;
        }

        function setCallState(isCalling) {
            document.getElementById('callBtn').disabled = isCalling;
            document.getElementById('hangupBtn').disabled = !isCalling;
            if(isCalling) {
                document.getElementById('callBtn').classList.add('secondary');
            } else {
                document.getElementById('callBtn').classList.remove('secondary');
            }
        }

        // --- Debug: Microphone Test ---
        function testMicrophone() {
            console.log("Requesting microphone access...");
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    console.log("Microphone access GRANTED");
                    alert("ì„±ê³µ! ë§ˆì´í¬ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤.\nSuccess! Microphone access granted.");
                    // Stop the stream immediately to release the mic
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(err => {
                    console.error("Microphone access DENIED:", err);
                    alert("ì‹¤íŒ¨! ë§ˆì´í¬ ê¶Œí•œì„ ì–»ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\nì—ëŸ¬: " + err.name + ": " + err.message + "\n\n(ì°¸ê³ : http://IPì£¼ì†Œ ë¡œ ì ‘ì† ì¤‘ì´ë¼ë©´ ë¸Œë¼ìš°ì €ê°€ ë³´ì•ˆìƒ ë§ˆì´í¬ë¥¼ ì°¨ë‹¨í•©ë‹ˆë‹¤. localhostë¡œ ì ‘ì†í•˜ê±°ë‚˜ Chrome ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.)");
                });
        }

        // --- SIP Logic ---
        function connectToSip() {
            const sipUri = document.getElementById('sipUri').value;
            const password = document.getElementById('sipPassword').value;
            const wsUrl = document.getElementById('wsUrl').value;

            if (!sipUri || !wsUrl) {
                alert('Please fill in SIP URI and WebSocket URL');
                return;
            }

            const socket = new JsSIP.WebSocketInterface(wsUrl);
            const configuration = {
                sockets: [socket],
                uri: sipUri,
                password: password,
                register: true
            };

            ua = new JsSIP.UA(configuration);

            ua.on('connected', () => {
                updateStatus('Connected to WebSocket', 'status-disconnected');
            });

            ua.on('disconnected', () => {
                updateStatus('Disconnected', 'status-disconnected');
                setCallState(false);
            });

            ua.on('registered', () => {
                updateStatus('Registered', 'status-registered');
            });

            ua.on('registrationFailed', (e) => {
                updateStatus('Registration Failed: ' + e.cause, 'status-error');
            });

            ua.on('newRTCSession', (data) => {
                const newSession = data.session;
                console.log('[UA] Event: newRTCSession');

                // ì´ë¯¸ í†µí™” ì¤‘ì¸ ê²½ìš° ì¢…ë£Œ (Busy)
                if (session) {
                    console.log('[UA] A session is already active. Terminating the new incoming session.');
                    newSession.terminate({
                        'status_code': 486,
                        'reason_phrase': 'Busy Here'
                    });
                    return;
                }

                session = newSession;
                
                if (session.direction === 'incoming') {
                    console.log(`[SESSION] Incoming call from ${session.remote_identity.uri}.`);
                    updateStatus(`Incoming Call from ${session.remote_identity.display_name || session.remote_identity.uri.user}`, 'status-registered');

                    // ë§ˆì´í¬ ê¶Œí•œì„ ì–»ê³  ìŠ¤íŠ¸ë¦¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    console.log('[SESSION] Requesting microphone access for incoming call...');
                    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                        .then(stream => {
                            console.log('[SESSION] Microphone access granted for incoming call.');
                            
                            // ìžë™ ìˆ˜ì‹  (ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ í¬í•¨)
                            const options = {
                                mediaStream: stream
                            };
                            console.log('[SESSION] Answering call with options:', options);
                            session.answer(options);

                             // Release mic when the call ends
                            session.on('ended', () => stream.getTracks().forEach(track => track.stop()));
                            session.on('failed', () => stream.getTracks().forEach(track => track.stop()));
                        })
                        .catch(err => {
                            console.error("[SESSION] Failed to get local stream for incoming call", err);
                            alert("ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ ì „í™”ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err.message);
                            session.terminate({
                                'status_code': 480,
                                'reason_phrase': 'Temporarily Unavailable'
                            });
                        });
                }

                setupSessionEvents(session);
            });

            ua.start();
        }

        function makeCall() {
            const target = document.getElementById('targetNumber').value;
            if (!target || !ua) {
                alert("Please connect to SIP first and enter a target number.");
                return;
            }
            console.log(`[makeCall] Starting call to ${target}`);

            // 1. Get User Media (Microphone)
            console.log('[makeCall] Requesting microphone access...');
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    console.log('[makeCall] Microphone access granted.');
                    
                    // Add tracks from the stream to the connection.
                    // This is a good practice for ensuring media flows correctly from the start.
                    stream.getTracks().forEach(track => {
                        console.log(`[makeCall] Adding local audio track: ${track.label}`);
                    });

                    // 2. Setup Call Options with the obtained stream
                    const eventHandlers = {
                        'progress': function(e) { console.log('[SESSION] Event: progress (call is ringing)'); },
                        'failed': function(e) {
                            console.error('Call failed:', e);
                            setCallState(false);
                            session = null;
                            stream.getTracks().forEach(track => track.stop()); // Stop mic on failure
                        },
                        'ended': function(e) {
                            console.log('Call ended:', e);
                            setCallState(false);
                            session = null;
                            stream.getTracks().forEach(track => track.stop()); // Stop mic on end
                        },
                        'confirmed': function(e) {
                            console.log('[SESSION] Event: confirmed (call is active).');
                            setCallState(true);
                        }
                    };

                    const options = {
                        'eventHandlers': eventHandlers,
                        'mediaStream': stream // Pass the microphone stream to the call
                    };

                    // 3. Initiate the call
                    console.log('[makeCall] Calling with options:', options);
                    session = ua.call(target, options);
                    setupSessionEvents(session);

                })
                .catch(err => {
                    console.error("[makeCall] Failed to get local stream", err);
                    alert("Could not start call: Failed to get microphone access. Error: " + err.message);
                });
        }

        function hangupCall() {
            if (session) {
                session.terminate();
            }
        }

        function setupSessionEvents(session) {
            console.log('[setupSessionEvents] Setting up event listeners for the new session.');

            // Listen for ICE connection state changes
            session.connection.addEventListener('iceconnectionstatechange', () => {
                const iceState = session.connection.iceConnectionState;
                console.log(`[ICE] Connection State Changed: ${iceState}`);
                if (iceState === 'failed' || iceState === 'disconnected' || iceState === 'closed') {
                     console.error(`[ICE] Connection to media server failed or was lost. State: ${iceState}`);
                     // You might want to update the UI here as well.
                }
                if (iceState === 'connected' || iceState === 'completed') {
                    console.log("[ICE] Media connection successfully established!");
                }
            });

            // Standard WebRTC track event (newer browsers)
            session.connection.addEventListener('track', (e) => {
                 console.log('[TRACK] Received remote media track.');
                 const remoteAudio = document.getElementById('remoteAudio');
                 
                 // Prevent interruption error by checking if a stream is already assigned
                 if (remoteAudio.srcObject !== e.streams[0]) {
                    console.log('[TRACK] Attaching remote stream to audio element.');
                    remoteAudio.srcObject = e.streams[0];
                    
                    console.log('[TRACK] Attempting to play remote audio...');
                    remoteAudio.play()
                        .then(() => {
                            console.log('[TRACK] remoteAudio.play() successfully initiated.');
                        })
                        .catch(error => {
                            console.error("[TRACK] remoteAudio.play() failed:", error);
                            alert("ì¤‘ìš”: ë¸Œë¼ìš°ì €ê°€ ìžë™ìž¬ìƒì„ ì°¨ë‹¨í–ˆì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤. íŽ˜ì´ì§€ì™€ ìƒí˜¸ìž‘ìš©(í´ë¦­ ë“±) í›„ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.");
                        });
                 } else {
                    console.log('[TRACK] Remote stream already attached. Ignoring duplicate track event.');
                 }
            });

            session.on('ended', () => {
                console.log('[SESSION] Event: ended');
                setCallState(false);
                session = null;
            });
            
            session.on('failed', (e) => {
                console.error('[SESSION] Event: failed', e);
                setCallState(false);
                session = null;
            });

             session.on('confirmed', () => {
                console.log('[SESSION] Event: confirmed (call is active).');
                setCallState(true);
            });
        }
    </script>
</body>
</html>